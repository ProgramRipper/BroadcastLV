from broadcastlv.command.danmu_msg import (
    ActivityInfo,
    DanmuMsg,
    DanmuMsgInfo,
    DanmuMsgInfoCheckInfo,
    DanmuMsgInfoLevel,
    ModeInfoExtra,
    DanmuMsgInfoMedal,
    DanmuMsgInfoMeta,
    DanmuMsgInfoSender,
    DmType,
    EmotionOptions,
    ModeInfo,
)


def test_danmu_msg_text():
    danmu_msg = DanmuMsg(
        "DANMU_MSG",
        DanmuMsgInfo(
            DanmuMsgInfoMeta(
                0,
                1,
                25,
                16777215,
                1672600510960,
                1672599856,
                0,
                "12de831c",
                0,
                0,
                0,
                "",
                DmType.Text,
                "{}",
                "{}",
                ModeInfo(
                    0,
                    0,
                    '{"send_from_me":false,"mode":0,"color":16777215,"dm_type":0,"font_size":25,"player_mode":1,"show_player_type":0,"content":"test","user_hash":"316572444","emoticon_unique":"","bulge_display":0,"recommend_score":7,"main_state_dm_color":"","objective_state_dm_color":"","direction":0,"pk_direction":0,"quartet_direction":0,"anniversary_crowd":0,"yeah_space_type":"","yeah_space_url":"","jump_to_url":"","space_type":"","space_url":"","animation":{},"emots":null}',
                ),
                ActivityInfo(activity_identity="", activity_source=0, not_show=0),
            ),
            "test",
            DanmuMsgInfoSender(
                1087319369,
                "ProgramRipper",
                1,
                0,
                0,
                10000,
                1,
                "",
            ),
            DanmuMsgInfoMedal(
                18,
                "鲸呆",
                "希月萌奈",
                22889484,
                13081892,
                "",
                0,
                13081892,
                13081892,
                13081892,
                0,
                1,
                591892279,
            ),
            DanmuMsgInfoLevel(
                9,
                0,
                9868950,
                ">50000",
                0,
            ),
            ("", ""),
            0,
            0,
            None,
            DanmuMsgInfoCheckInfo(ts=1672600510, ct="78573A9F"),
            0,
            0,
            None,
            None,
            0,
            91,
        ),
    )
    data = b'{"cmd":"DANMU_MSG","info":[[0,1,25,16777215,1672600510960,1672599856,0,"12de831c",0,0,0,"",0,"{}","{}",{"mode":0,"show_player_type":0,"extra":"{\\"send_from_me\\":false,\\"mode\\":0,\\"color\\":16777215,\\"dm_type\\":0,\\"font_size\\":25,\\"player_mode\\":1,\\"show_player_type\\":0,\\"content\\":\\"test\\",\\"user_hash\\":\\"316572444\\",\\"emoticon_unique\\":\\"\\",\\"bulge_display\\":0,\\"recommend_score\\":7,\\"main_state_dm_color\\":\\"\\",\\"objective_state_dm_color\\":\\"\\",\\"direction\\":0,\\"pk_direction\\":0,\\"quartet_direction\\":0,\\"anniversary_crowd\\":0,\\"yeah_space_type\\":\\"\\",\\"yeah_space_url\\":\\"\\",\\"jump_to_url\\":\\"\\",\\"space_type\\":\\"\\",\\"space_url\\":\\"\\",\\"animation\\":{},\\"emots\\":null}"},{"activity_identity":"","activity_source":0,"not_show":0}],"test",[1087319369,"ProgramRipper",1,0,0,10000,1,""],[18,"\xe9\xb2\xb8\xe5\x91\x86","\xe5\xb8\x8c\xe6\x9c\x88\xe8\x90\x8c\xe5\xa5\x88",22889484,13081892,"",0,13081892,13081892,13081892,0,1,591892279],[9,0,9868950,"\\u003e50000",0],["",""],0,0,null,{"ts":1672600510,"ct":"78573A9F"},0,0,null,null,0,91]}'

    assert danmu_msg == DanmuMsg.from_bytes(data)


def test_danmu_msg_emoji():
    danmu_msg = DanmuMsg(
        "DANMU_MSG",
        DanmuMsgInfo(
            DanmuMsgInfoMeta(
                0,
                1,
                25,
                16777215,
                1672600515362,
                1672599856,
                0,
                "12de831c",
                0,
                0,
                0,
                "",
                DmType.Emoji,
                EmotionOptions(
                    bulge_display=0,
                    emoticon_unique="official_114",
                    height=60,
                    in_player_area=1,
                    is_dynamic=1,
                    url="http://i0.hdslb.com/bfs/live/40db7427f02a2d9417f8eeed0f71860dfb28df5a.png",
                    width=195,
                ),
                "{}",
                ModeInfo(
                    0,
                    0,
                    '{"send_from_me":false,"mode":0,"color":16777215,"dm_type":1,"font_size":25,"player_mode":1,"show_player_type":0,"content":"what","user_hash":"316572444","emoticon_unique":"official_114","bulge_display":0,"recommend_score":7,"main_state_dm_color":"","objective_state_dm_color":"","direction":0,"pk_direction":0,"quartet_direction":0,"anniversary_crowd":0,"yeah_space_type":"","yeah_space_url":"","jump_to_url":"","space_type":"","space_url":"","animation":{},"emots":null}',
                ),
                ActivityInfo(activity_identity="", activity_source=0, not_show=0),
            ),
            "what",
            DanmuMsgInfoSender(
                1087319369,
                "ProgramRipper",
                1,
                0,
                0,
                10000,
                1,
                "",
            ),
            DanmuMsgInfoMedal(
                level=18,
                name="鲸呆",
                uname="希月萌奈",
                room_id=22889484,
                color=13081892,
                text="",
                code=0,
                color_border=13081892,
                color_start=13081892,
                color_end=13081892,
                guard_type=0,
                is_lighted=1,
                uid=591892279,
            ),
            DanmuMsgInfoLevel(
                9,
                0,
                9868950,
                ">50000",
                0,
            ),
            ("", ""),
            0,
            0,
            None,
            DanmuMsgInfoCheckInfo(ts=1672600515, ct="5BDD7605"),
            0,
            0,
            None,
            None,
            0,
            91,
        ),
    )
    data = b'{"cmd":"DANMU_MSG","info":[[0,1,25,16777215,1672600515362,1672599856,0,"12de831c",0,0,0,"",1,{"bulge_display":0,"emoticon_unique":"official_114","height":60,"in_player_area":1,"is_dynamic":1,"url":"http://i0.hdslb.com/bfs/live/40db7427f02a2d9417f8eeed0f71860dfb28df5a.png","width":195},"{}",{"mode":0,"show_player_type":0,"extra":"{\\"send_from_me\\":false,\\"mode\\":0,\\"color\\":16777215,\\"dm_type\\":1,\\"font_size\\":25,\\"player_mode\\":1,\\"show_player_type\\":0,\\"content\\":\\"what\\",\\"user_hash\\":\\"316572444\\",\\"emoticon_unique\\":\\"official_114\\",\\"bulge_display\\":0,\\"recommend_score\\":7,\\"main_state_dm_color\\":\\"\\",\\"objective_state_dm_color\\":\\"\\",\\"direction\\":0,\\"pk_direction\\":0,\\"quartet_direction\\":0,\\"anniversary_crowd\\":0,\\"yeah_space_type\\":\\"\\",\\"yeah_space_url\\":\\"\\",\\"jump_to_url\\":\\"\\",\\"space_type\\":\\"\\",\\"space_url\\":\\"\\",\\"animation\\":{},\\"emots\\":null}"},{"activity_identity":"","activity_source":0,"not_show":0}],"what",[1087319369,"ProgramRipper",1,0,0,10000,1,""],[18,"\xe9\xb2\xb8\xe5\x91\x86","\xe5\xb8\x8c\xe6\x9c\x88\xe8\x90\x8c\xe5\xa5\x88",22889484,13081892,"",0,13081892,13081892,13081892,0,1,591892279],[9,0,9868950,"\\u003e50000",0],["",""],0,0,null,{"ts":1672600515,"ct":"5BDD7605"},0,0,null,null,0,91]}'

    assert danmu_msg == DanmuMsg.from_bytes(data)


def test_danmu_msg_mode_info_extra():
    danmu_msg = DanmuMsg(
        "DANMU_MSG",
        DanmuMsgInfo(
            DanmuMsgInfoMeta(
                0,
                1,
                25,
                16777215,
                1672600515362,
                1672599856,
                0,
                "12de831c",
                0,
                0,
                0,
                "",
                DmType.Emoji,
                EmotionOptions(
                    bulge_display=0,
                    emoticon_unique="official_114",
                    height=60,
                    in_player_area=1,
                    is_dynamic=1,
                    url="http://i0.hdslb.com/bfs/live/40db7427f02a2d9417f8eeed0f71860dfb28df5a.png",
                    width=195,
                ),
                "{}",
                ModeInfo(
                    0,
                    0,
                    '{"send_from_me":false,"mode":0,"color":16777215,"dm_type":1,"font_size":25,"player_mode":1,"show_player_type":0,"content":"what","user_hash":"316572444","emoticon_unique":"official_114","bulge_display":0,"recommend_score":7,"main_state_dm_color":"","objective_state_dm_color":"","direction":0,"pk_direction":0,"quartet_direction":0,"anniversary_crowd":0,"yeah_space_type":"","yeah_space_url":"","jump_to_url":"","space_type":"","space_url":"","animation":{},"emots":null}',
                ),
                ActivityInfo(activity_identity="", activity_source=0, not_show=0),
            ),
            "what",
            DanmuMsgInfoSender(
                1087319369,
                "ProgramRipper",
                1,
                0,
                0,
                10000,
                1,
                "",
            ),
            DanmuMsgInfoMedal(
                level=18,
                name="鲸呆",
                uname="希月萌奈",
                room_id=22889484,
                color=13081892,
                text="",
                code=0,
                color_border=13081892,
                color_start=13081892,
                color_end=13081892,
                guard_type=0,
                is_lighted=1,
                uid=591892279,
            ),
            DanmuMsgInfoLevel(
                9,
                0,
                9868950,
                ">50000",
                0,
            ),
            ("", ""),
            0,
            0,
            None,
            DanmuMsgInfoCheckInfo(ts=1672600515, ct="5BDD7605"),
            0,
            0,
            None,
            None,
            0,
            91,
        ),
    )
    extra = danmu_msg.info.meta.mode_info.extra

    assert extra == ModeInfoExtra(
        send_from_me=False,
        mode=0,
        color=16777215,
        dm_type=DmType.Emoji,
        font_size=25,
        player_mode=1,
        show_player_type=0,
        content="what",
        user_hash="316572444",
        emoticon_unique="official_114",
        bulge_display=0,
        recommend_score=7,
        main_state_dm_color="",
        objective_state_dm_color="",
        direction=0,
        pk_direction=0,
        quartet_direction=0,
        anniversary_crowd=0,
        yeah_space_type="",
        yeah_space_url="",
        jump_to_url="",
        space_type="",
        space_url="",
        animation={},
        emots=None,
    )
    assert danmu_msg.info.meta.mode_info.extra is extra
